# ICMP\(Internet Control Message Protocol\)

H3C网络设备-交换机中对ICMP数据进行流定义的方式：ACL条目

![](/assets/ICMP报文流定义.png)

定义：网际控制报文协议，是一种面向连接的协议，常常被看做IP的一部分

功用：主要用来传递差错报文、控制报文和查询报文；IP本身没有内在机制来获取差错报文并处理，TCP/IP为了IP能够处理这些差错，设计了ICMP；ICMP协议与ARP协议不同，ICMP靠IP协议来完成任务，所以ICMP报文中要封装IP头部。。

应用实例：当某个网关发现传输错误的时候，就向信源主机发送一个差错报文（ICMP报文），来报告差错信息，让信源主机采取相应的措施。

传输方式：ICMP报文在IP数据报文内部传输，被封装在IP数据报的数据部分。

![](/assets/icmp报文封装位置.png)

ICMP报文的数据结构：

![](/assets/icmp报文数据结构.png)

ICMP报文头长度为8字节，前四个字节的含义是固定不变的：

类型：前8比特位表示了ICMP报文类型

代码：8个比特位，表示指定类型中的一个功能，如果一个类型只有一种功能，则置为0.

校验和：16比特位的校验和

ICMP报文类型：差错报文和查询报文

![](/assets/ICMP报文类型.png)



ICMP差错报文：当发送ICMP差错报文时，ICMP报文的数据部分总是包含IP数据报头和IP数据部分的前8个字节，然和加上8字节ICMP报头被封装在IP数据报中。

接收ICMP报文的模块会将它与某个特定协议（根据IP数据报头）和用户进程（IP数据部分的前八个字节-TCP或者UDP报头判断出）联系起来

![](/assets/icmp差错报文封装内容及过程.png)

 不能产生icmp差错报文的情况：

1、ICMP差错报文

2、目的IP地址为广播地址和组播地址

3、第一个报文片后面的所有数据报片

4、作为链路层的广播数据报

5、特殊的IP地址。例如：127.0.0.0 、0.0.0.0

ICMP报文类型：

1、ICMP目标不可达消息:IP路由器无法将数据报传输给目的端，会返回一个目的不可达ICMP报文，并显示具体不可达原因

2、ICMP重定向消息：IP路由器发现信源主机使用次优路径传输报文的时候，会返回给信源主机一个ICMP重定向报文，主要包括最佳路由信息和源数据。

3、ICMP超时消息：IP报文中有个TTL字段，每经过一个路由器减一，当减至零是还没有到达目的主机时，会返回一个超时消息

4、源抑制消息：信源主机发送数据到另一端的时候，当IP路由器或者链路达到饱和状态的时候，会返回一个源抑制消息。

ICMP查询报文：

1、ICMP回送消息：用于主机活路由器之间判断数据是否成功送到对端，可以向对端发送回送请求消息，也可接受对端的回送应答消息（不再使用）

2、ICMP地址掩码消息：用于主机或者路由想要了解掩码信息，向那些主机和路由器发送地址掩码请求信息，然后接受地址掩码应答消息获取对端掩码信息。

3、ICMP时间戳消息：向对端发送时间戳请求消息，然后接收时间戳应答消息以获取对端时间信息。































































